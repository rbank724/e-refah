<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>کتابخانه طرح‌ها</title>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .pagination-btn { @apply px-2 py-1 m-1 rounded; }
    .pagination-active { @apply bg-green-600 text-white; }
    .pagination-inactive { @apply bg-gray-200 text-black; }
    .category-text {
      color:#000;
      text-shadow:0 1px 2px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body class="bg-gray-50 flex flex-col items-center p-4">
  <!-- نوار جستجو -->
  <input id="search" type="text"
         placeholder="جستجو..."
         class="w-full max-w-3xl border p-2 mb-4 rounded" />

  <!-- منوی انتخاب دسته‌بندی -->
  <select id="category" class="w-full max-w-3xl border p-2 mb-4 rounded">
    <option value="">همه دسته‌بندی‌ها</option>
  </select>

  <!-- نتایج -->
  <div id="results" class="mt-4 w-full max-w-3xl"></div>

  <!-- صفحه‌بندی -->
  <div id="pagination" class="flex justify-center mt-4"></div>

  <!-- جزئیات -->
  <div id="loading" class="hidden text-green-600 mt-4">در حال بارگذاری...</div>
  <div id="detail" class="hidden w-full max-w-3xl bg-white p-4 rounded shadow-md mt-4"></div>

  <script>
    let data = [];
    let filteredResults = [];
    let currentPage = 1;
    const perPage = 9;

    const searchInput = document.getElementById("search");
    const categorySelect = document.getElementById("category");
    const resultsDiv = document.getElementById("results");
    const paginationDiv = document.getElementById("pagination");
    const loading = document.getElementById("loading");
    const detail = document.getElementById("detail");

    const fileCache = new Map();

    // دریافت داده‌ها
    fetch("data.json").then(res=>res.json()).then(json=>{
      data=json;
      // پر کردن منوی دسته‌بندی
      const cats=[...new Set(data.map(i=>i.category))];
      cats.forEach(c=>{
        const opt=document.createElement("option");
        opt.value=c; opt.textContent=c;
        categorySelect.appendChild(opt);
      });
      filterData();
    });

    // فیلتر و جستجو
    searchInput.addEventListener("input", filterData);
    categorySelect.addEventListener("change", filterData);

    function filterData(){
      const search=searchInput.value.trim();
      const category=categorySelect.value;
      let results=data;
      if(category) results=results.filter(i=>i.category===category);
      if(search){
        const fuse=new Fuse(results,{keys:["title","keywords"],threshold:0.3});
        results=fuse.search(search);
      }
      filteredResults=results;
      currentPage=1;
      renderPage(currentPage);
    }

    function renderPage(page){
      resultsDiv.innerHTML=""; paginationDiv.innerHTML=""; hideDetail();
      if(filteredResults.length===0){ resultsDiv.style.display="none"; return; }

      const start=(page-1)*perPage;
      const pageItems=filteredResults.slice(start,start+perPage);

      // گرید یا تک‌ستونی
      if(pageItems.length===1){
        resultsDiv.className="mt-4 w-full max-w-3xl flex justify-center";
      } else {
        resultsDiv.className="mt-4 w-full max-w-3xl gap-4 grid grid-cols-2 md:grid-cols-3";
      }

      pageItems.forEach(r=>{
        const item=r.item||r;
        const div=document.createElement("div");
        div.className="result-item p-4 bg-green-500 text-white shadow-md text-sm sm:text-base max-w-[28rem]";
        div.innerHTML=`<strong>${item.title}</strong>`; // فقط عنوان
        div.onclick=()=>{
          resultsDiv.style.display="none"; loading.style.display="block";
          if(fileCache.has(item.file)){
            showDetail(item,fileCache.get(item.file));
          } else {
            fetch(item.file).then(res=>res.text()).then(html=>{
              fileCache.set(item.file,html);
              showDetail(item,html);
            });
          }
        };
        resultsDiv.appendChild(div);
      });

      const totalPages=Math.ceil(filteredResults.length/perPage);
      if(totalPages>1){
        for(let i=1;i<=totalPages;i++){
          const btn=document.createElement("button");
          btn.textContent=i;
          btn.className="pagination-btn "+(i===page?"pagination-active":"pagination-inactive");
          btn.onclick=()=>{currentPage=i; renderPage(i);}
          paginationDiv.appendChild(btn);
        }
      }
    }

    function showDetail(item,html){
      loading.style.display="none";
      detail.innerHTML=`<h2 class="text-lg font-bold mb-2">${item.title}</h2>${html}`;
      detail.classList.remove("hidden");
    }

    function hideDetail(){
      detail.classList.add("hidden");
      detail.innerHTML="";
      loading.style.display="none";
    }
  </script>
</body>
</html>
